#!/bin/bash
set -e
source $(pwd)/.prj
args=("$@")
dd=0 #delete default constructor
dc=0 #delete copy constructor with operator=
dm=0 #delete move constructor with operator=
v=0  #variables flag
vars=""
declare -a classes
for opt in ${args[@]}; do
    if [ $v -eq 0 ]; then
		if [[ "$opt" == "-dd" ]]; then
		    dd=1
		elif [[ "$opt" == "-dc" ]]; then                                                                           
		    dc=1
		elif [[ "$opt" == "-dm" ]]; then                                                                           
		    dm=1
		elif [[ "$opt" == "-v" ]]; then
			v=1;
		else
			classes[${#classes[*]}]="$opt"
		fi
	else
		vars="${vars} $opt"
	fi
done
vars=`echo $vars | sed "s/;/;\n       /g"`
class_name=${classes[0]}
classes=("${classes[@]:1}")
flag=0
if [ ${#classes[@]} -ne 0 ]; then
	separator=", " # e.g. constructing regex, pray it does not contain %s
	regex="$( printf "${separator}%s" "${classes[@]}" )"
	parents="${regex:${#separator}}" # remove leading separator
	flag=1
fi
if [ -e "include" -a -e "src" ]; then
	if [ -e "include/$class_name.hpp" -o -e "src/$class_name.cpp" ]; then
		echo "File exists. Exit"
		exit
	fi
	d=$(date +%x\ %X)
	m4 -D cls=$class_name -D d="$d" -D dm=$dm -D dd=$dd -D dc=$dc -D auth="$auth" /etc/cpprj/cls_dummy.hpp.m4 > include/$class_name.hpp
	m4 -D cls=$class_name -D d="$d" -D dm=$dm -D dd=$dd -D dc=$dc -D auth="$auth" /etc/cpprj/cls_dummy.cpp.m4 > src/$class_name.cpp
	
	for ((a = ${#classes[@]} - 1;a >= 0; a--)); do
		sed -i "/#pragma once/ a #include \"${classes[a]}.hpp\"" include/$class_name.hpp
	done
	parents1=`echo $parents | sed 's|, |(), |g'`
	if [ $flag -eq 1 ]; then
		sed -i "s|() cls_parents|(): $parents1|g" src/$class_name.cpp
		sed -i "s|^cls_parents|$parents1|g" src/$class_name.cpp
		sed -i "s|cls_parents|\: $parents|g" include/$class_name.hpp
	else
		sed -i "s|cls_parents(), ||g" src/$class_name.cpp
		sed -i "s|cls_parents()||g" src/$class_name.cpp                                            
        sed -i "s|cls_parents||g" include/$class_name.hpp
	fi
	sed -i "s|(SOURCE_FILES|(SOURCE_FILES\n\t\tsrc/$class_name.cpp|" CMakeLists.txt
	if [ $v -eq 1 ]; then
		vars=${vars//\\/\\\\}
		vars=${vars//&/\\&}
		vars=${vars//|/\\|}
		vars=${vars//;/\\;\\}
		sed -i "s|\/\*data\*\/|$vars|" include/$class_name.hpp
	fi
	sed -i '/./,/^$/!d' include/$class_name.hpp
	sed -i '/./,/^$/!d' src/$class_name.cpp
else
	echo "You are not in the project directory! Exit"
fi
