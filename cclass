#!/bin/bash
set -e
source $(pwd)/.prj
args=("$@")
dd=0 #delete default constructor
dc=0 #delete copy constructor with operator=
dm=0 #delete move constructor with operator=
declare -a classes
for opt in ${args[@]}; do
    if [[ "$opt" == "-dd" ]]; then
	    dd=1
	elif [[ "$opt" == "-dc" ]]; then                                                                           
        dc=1
	elif [[ "$opt" == "-dm" ]]; then                                                                           
	    dm=1
	else
		classes[${#classes[*]}]="$opt"
	fi
done
#echo "${classes[@]}"
class_name=${classes[0]}
classes=("${classes[@]:1}")
#echo $class_name

if [ ${#classes[@]} -ne 0 ]; then
	separator=", " # e.g. constructing regex, pray it does not contain %s
	regex="$( printf "${separator}%s" "${classes[@]}" )"
	parents="${regex:${#separator}}" # remove leading separator
fi
if [ -e "include" -a -e "src" ]; then
	d=$(date +%x\ %X)
	cp /etc/cpprj/cls_dummy.hpp include/$class_name.hpp
	cp /etc/cpprj/cls_dummy.cpp src/$class_name.cpp
	
	if [ $dd -eq 1 ]; then
		sed -i "s|^\t\t\$cls();|\t\t\$cls() = delete;|" include/$class_name.hpp
		sed -i "/\$cls::\$cls()/,/^}/d" src/$class_name.cpp
	fi
	if [ $dc -eq 1 ]; then
	    sed -i "s|\$cls(const \$cls&);|\$cls(const \$cls\\&) = delete;|" include/$class_name.hpp
		sed -i "s|\$cls(\$cls&);|\$cls(\$cls\\&) = delete;|" include/$class_name.hpp
		sed -i "/\$cls operator=(const \$cls\\&);/d" include/$class_name.hpp
		
		sed -i "/\$cls::\$cls(const \$cls\\& from)/,/^}/d" src/$class_name.cpp
		sed -i "/\$cls::\$cls(\$cls\\& from)/,/^}/d" src/$class_name.cpp
		sed -i "/\$cls \$cls::operator=(const \$cls\\& from)/,/^}/d" src/$class_name.cpp
	fi
	if [ $dm -eq 1 ]; then 
	    sed -i "s|\$cls(\$cls\\&\\&);|\$cls(\$cls\\&\\&) = delete;|" include/$class_name.hpp
		sed -i "/\$cls\\& operator=(const \$cls\\&\\&);/d" include/$class_name.hpp
		
	    sed -i "s|\$cls::\$cls(\$cls\\&\\& from)/,/^}||" src/$class_name.cpp
		sed -i "s|\$cls\\& \$cls::operator=(const \$cls\\&\\&)/,/^}||" src/$class_name.cpp
	fi
	parents1=": $parents";
	sed -i "s|\$cls_parents|$parents1|" src/$class_name.cpp
	sed -i "s|\$cls_parents|$parents|g" src/$class_name.cpp
	sed -i "s|\$cls_parents|$parents1|g" include/$class_name.hpp
	sed -i "s|\$cls|$class_name|g" include/$class_name.hpp
	sed -i "s|\$cls|$class_name|g" src/$class_name.cpp
	sed -i "s|\$auth|$auth|g" include/$class_name.hpp
	sed -i "s|\$d|$d|g" include/$class_name.hpp
	sed -i "s|\$auth|$auth|g" src/$class_name.cpp
	sed -i "s|\$d|$d|g" src/$class_name.cpp
	sed -i "s|SOURCE_FILES|SOURCE_FILES\n\t\tsrc/$class_name.cpp|" CMakeLists.txt
else
	echo "You are not in the project directory! Exit"
fi
